<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <title>Stripe Subscriptions with Node.js</title>
</head>

<body>
    <div class="p-5">
        <!-- Header -->
        <div class="pricing-header p-3 pb-md-4 mx-auto text-center">
            <h1 class="display-4 fw-normal">Pricing</h1>
            <p class="fs-5 text-muted text-wrap">
                Quickly build an effective pricing table for your potential customers with this Bootstrap example.
                Itâ€™s built with default Bootstrap components and utilities with little customization.
            </p>
        </div>

        <div class="container p-3">
            <div class="row row-cols-1 row-cols-md-4 mb-3 text-center">
                <!-- Starter Plan -->
                <div class="col">
                    <div class="card mb-4 rounded-3 shadow-sm">
                        <div class="card-header py-3 text-white bg-dark border-dark">
                            <h4 class="my-0 fw-normal">Starter</h4>
                        </div>
                        <div class="card-body">
                            <h1 id="starter-price" class="card-title pricing-card-title">$--</h1>
                            <small class="text-muted fw-light">/weekly</small>
                            <ul class="list-unstyled mt-3 mb-4 fw-bold">
                                <li>10 users included</li>
                                <li>2 GB of storage</li>
                                <li>Email support</li>
                                <li>Help center access</li>
                            </ul>
                            <p class="lead">The Starter Plan is perfect for individuals or small teams just getting
                                started.</p>
                            <div class="mb-3">
                                <input type="text" class="form-control mb-2" placeholder="Enter coupon code"
                                    id="coupon-starter">
                                <button onclick="validateCoupon('starter')"
                                    class="w-100 btn btn-sm btn-secondary mb-2">Apply Coupon</button>
                            </div>
                            <a type="button" href="/subscribe?plan=starter" id="subscribe-starter"
                                class="w-100 btn btn-lg btn-outline-dark">Subscribe</a>
                        </div>
                    </div>
                </div>

                <!-- Pro Plan -->
                <div class="col">
                    <div class="card mb-4 rounded-3 shadow-sm">
                        <div class="card-header py-3 text-white bg-dark border-dark">
                            <h4 class="my-0 fw-normal">Pro</h4>
                        </div>
                        <div class="card-body">
                            <h1 id="pro-price" class="card-title pricing-card-title">$--</h1>
                            <small class="text-muted fw-light">/monthly</small>
                            <ul class="list-unstyled mt-3 mb-4 fw-bold">
                                <li>20 users included</li>
                                <li>10 GB of storage</li>
                                <li>Priority email support</li>
                                <li>Help center access</li>
                            </ul>
                            <p class="lead">Designed for growing teams, offering enhanced features and flexibility.</p>
                            <div class="mb-3">
                                <input type="text" class="form-control mb-2" placeholder="Enter coupon code"
                                    id="coupon-pro">
                                <button onclick="validateCoupon('pro')"
                                    class="w-100 btn btn-sm btn-secondary mb-2">Apply Coupon</button>
                            </div>
                            <a type="button" href="/subscribe?plan=pro" id="subscribe-pro"
                                class="w-100 btn btn-lg btn-outline-dark">Subscribe</a>
                        </div>
                    </div>
                </div>

                <!-- Premium Plan -->
                <div class="col">
                    <div class="card mb-4 rounded-3 shadow-sm">
                        <div class="card-header py-3 text-white bg-dark border-dark">
                            <h4 class="my-0 fw-normal">Premium</h4>
                        </div>
                        <div class="card-body">
                            <h1 id="premium-price" class="card-title pricing-card-title">$--</h1>
                            <small class="text-muted fw-light">/yearly</small>
                            <ul class="list-unstyled mt-3 mb-4 fw-bold">
                                <li>30 users included</li>
                                <li>15 GB of storage</li>
                                <li>Phone and email support</li>
                                <li>Help center access</li>
                            </ul>
                            <p class="lead">Unlock the full potential with personalized onboarding support.</p>
                            <div class="mb-3">
                                <input type="text" class="form-control mb-2" placeholder="Enter coupon code"
                                    id="coupon-premium">
                                <button onclick="validateCoupon('premium')"
                                    class="w-100 btn btn-sm btn-secondary mb-2">Apply Coupon</button>
                            </div>
                            <a type="button" href="/subscribe?plan=premium" id="subscribe-premium"
                                class="w-100 btn btn-lg btn-outline-dark">Subscribe</a>
                        </div>
                    </div>
                </div>

                <!-- Extreme Plan -->
                <div class="col">
                    <div class="card mb-4 rounded-3 shadow-sm">
                        <div class="card-header py-3 text-white bg-dark border-dark">
                            <h4 class="my-0 fw-normal">Extreme</h4>
                        </div>
                        <div class="card-body">
                            <h1 id="extreme-price" class="card-title pricing-card-title">$--</h1>
                            <small class="text-muted fw-light">/yearly</small>
                            <ul class="list-unstyled mt-3 mb-4 fw-bold">
                                <li>Unlimited users</li>
                                <li>20 GB of storage</li>
                                <li>Phone and email support</li>
                                <li>Help center access</li>
                            </ul>
                            <p class="lead">Access exclusive features like advanced analytics and custom integrations.
                            </p>
                            <div class="mb-3">
                                <input type="text" class="form-control mb-2" placeholder="Enter coupon code"
                                    id="coupon-extreme">
                                <button onclick="validateCoupon('extreme')"
                                    class="w-100 btn btn-sm btn-secondary mb-2">Apply Coupon</button>
                            </div>
                            <a type="button" href="/subscribe?plan=extreme" id="subscribe-extreme"
                                class="w-100 btn btn-lg btn-outline-dark">Subscribe</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let originalPrices = {}; // Store original prices for reference

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/get-all-prices');
                const data = await response.json();

                if (!data.success) {
                    throw new Error('Failed to fetch price IDs');
                }

                const plans = data.prices;

                // Fetch prices for each plan
                Object.keys(plans).forEach(plan => {
                    fetch(`/get-price/${plans[plan]}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const price = (data.price.unit_amount / 100).toFixed(2);
                                // Store original price
                                originalPrices[plan] = parseFloat(price);
                                document.getElementById(`${plan}-price`).innerText = `$${price}`;
                            } else {
                                console.error(`Failed to fetch price for ${plan}:`, data.message);
                            }
                        })
                        .catch(error => console.error(`Error fetching ${plan} price:`, error));
                });
            } catch (error) {
                console.error('Error fetching price IDs:', error);
            }
        });

        async function validateCoupon(planType) {
            const couponCode = document.getElementById(`coupon-${planType}`).value;
            const subscribeBtn = document.getElementById(`subscribe-${planType}`);
            const priceElement = document.getElementById(`${planType}-price`);

            try {
                const response = await fetch('/validate-coupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ coupon: couponCode })
                });

                const data = await response.json();

                if (data.success) {
                    // Update the subscribe button's href to include the coupon
                    const currentHref = subscribeBtn.getAttribute('href');
                    const baseHref = currentHref.split('&')[0]; // Remove any existing coupon
                    subscribeBtn.setAttribute('href', `${baseHref}&coupon=${couponCode}`);

                    // Calculate and display discounted price
                    const originalPrice = originalPrices[planType];
                    let discountedPrice = originalPrice;

                    if (data.coupon.percent_off) {
                        discountedPrice = originalPrice * (1 - data.coupon.percent_off / 100);
                    } else if (data.coupon.amount_off) {
                        // Convert amount_off from cents to dollars
                        discountedPrice = originalPrice - (data.coupon.amount_off / 100);
                    }

                    // Update the displayed price
                    priceElement.innerHTML = `
                        <span class="text-decoration-line-through text-muted">$${originalPrice.toFixed(2)}</span>
                        <span class="text-success">$${discountedPrice.toFixed(2)}</span>
                    `;

                    alert('Coupon applied successfully!');
                } else {
                    // Reset price display to original
                    priceElement.innerText = `$${originalPrices[planType].toFixed(2)}`;
                    // Reset subscribe button href to original
                    const baseHref = subscribeBtn.getAttribute('href').split('&')[0];
                    subscribeBtn.setAttribute('href', baseHref);
                    alert(data.message || 'Invalid coupon code');
                }
            } catch (error) {
                console.error('Error validating coupon:', error);
                alert('Error validating coupon');
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>